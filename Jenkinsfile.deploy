pipeline {
  agent any

  parameters {
    string(name: 'VERSION_TAG', defaultValue: 'v1.0-blue', description: 'Enter Docker image version (e.g. v1.0-green)')
    choice(name: 'DEPLOY_COLOR', choices: ['blue', 'green'], description: 'Choose which version to deploy')
    booleanParam(name: 'APPLY_SERVICES', defaultValue: false, description: 'Apply service YAMLs (only on first deploy or update)')
  }

  environment {
    CLUSTER_NAME = 'vincloudops-ecommerce-eks'
    AWS_REGION   = 'us-east-1'
    KUBECONFIG   = "${env.WORKSPACE}/kubeconfig"
  }

  stages {

    stage('Configure kubeconfig') {
      steps {
        withCredentials([[$class: 'AmazonWebServicesCredentialsBinding', credentialsId: 'aws-ecr']]) {
          sh '''
            echo "‚öôÔ∏è Setting up kubeconfig for EKS cluster"
            aws eks update-kubeconfig \
              --name $CLUSTER_NAME \
              --region $AWS_REGION \
              --kubeconfig $KUBECONFIG
          '''
        }
      }
    }

    stage('Deploy Services (Optional)') {
      when {
        expression { return params.APPLY_SERVICES == true }
      }
      steps {
        withCredentials([[$class: 'AmazonWebServicesCredentialsBinding', credentialsId: 'aws-ecr']]) {
          withEnv(["KUBECONFIG=${env.KUBECONFIG}"]) {
            sh '''
              echo "üåê Applying frontend & backend service YAMLs"
              kubectl apply -f k8s/frontend-service.yaml
              kubectl apply -f k8s/backend-service.yaml
            '''
          }
        }
      }
    }

    stage('Deploy to EKS (Dynamic Version)') {
      steps {
        withCredentials([[$class: 'AmazonWebServicesCredentialsBinding', credentialsId: 'aws-ecr']]) {
          withEnv(["KUBECONFIG=${env.KUBECONFIG}", "VERSION_TAG=${params.VERSION_TAG}", "DEPLOY_COLOR=${params.DEPLOY_COLOR}"]) {
            sh '''
              echo "üì¶ Injecting version tag: $VERSION_TAG into deployment files"

              echo "üîÑ Rendering backend-$DEPLOY_COLOR.yaml"
              envsubst < k8s/backend-$DEPLOY_COLOR.yaml > rendered-backend.yaml

              echo "üîÑ Rendering frontend-$DEPLOY_COLOR.yaml"
              envsubst < k8s/frontend-$DEPLOY_COLOR.yaml > rendered-frontend.yaml

              echo "üöÄ Applying backend deployment"
              kubectl apply -f rendered-backend.yaml

              echo "üöÄ Applying frontend deployment"
              kubectl apply -f rendered-frontend.yaml
            '''
          }
        }
      }
    }

                 stage('Patch Services to New Version') {
      steps {
        withCredentials([[$class: 'AmazonWebServicesCredentialsBinding', credentialsId: 'aws-ecr']]) {
          withEnv(["KUBECONFIG=${env.KUBECONFIG}", "DEPLOY_COLOR=${params.DEPLOY_COLOR}"]) {
            sh """
              echo "üîß Patching backend-svc to point to version=${DEPLOY_COLOR}"
              kubectl patch svc backend-svc -p '{\"spec\":{\"selector\":{\"app\":\"backend\",\"version\":\"${DEPLOY_COLOR}\"}}}'

              echo "üîß Patching frontend-service to point to version=${DEPLOY_COLOR}"
              kubectl patch svc frontend-service -p '{\"spec\":{\"selector\":{\"app\":\"frontend\",\"version\":\"${DEPLOY_COLOR}\"}}}'
            """
          }
        }
      }
    }
 }
  post {
    success {
      echo "‚úÖ Successfully deployed ${params.DEPLOY_COLOR} version with image tag ${params.VERSION_TAG}!"
    }
    failure {
      echo "‚ùå Deployment failed. Check logs above."
    }
  }
}
